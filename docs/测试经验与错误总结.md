# 测试经验与错误总结

## 测试策略总结

### 测试分层
1. **单元测试**：测试独立组件和函数
   - 使用 Vitest 进行单元测试
   - 测试组件的基本功能和边界条件
   - 使用 mock 数据模拟外部依赖

2. **集成测试**：测试组件间的交互
   - 测试组件间的数据传递
   - 测试事件处理和状态变化
   - 验证组件组合的正确性

3. **端到端测试**：测试完整的用户流程
   - 使用 Playwright 进行 E2E 测试
   - 测试用户操作的完整流程
   - 验证应用的整体功能

### 测试数据管理
1. **Mock 数据**：使用 mock 数据进行测试
   - 创建真实的测试数据
   - 覆盖各种边界情况
   - 保持数据的一致性

2. **测试环境**：建立独立的测试环境
   - 使用测试专用的配置文件
   - 隔离测试数据和生产数据
   - 确保测试的可重复性

## 常见错误及解决方案

### 地图相关错误

#### 1. 地图容器初始化错误
**错误现象**：地图无法正常显示或加载
**原因分析**：
- 地图容器 DOM 元素未正确获取
- 地图 API 密钥配置错误
- 网络连接问题

**解决方案**：
```javascript
// 确保 DOM 元素存在后再初始化地图
onMounted(() => {
  const mapContainer = document.getElementById('map-container')
  if (mapContainer) {
    initMap()
  }
})
```

#### 2. 坐标转换错误
**错误现象**：车辆位置显示错误
**原因分析**：
- 坐标系不匹配（WGS84 vs GCJ02）
- 坐标数据格式错误
- 转换函数实现错误

**解决方案**：
```javascript
// 统一使用 WGS84 坐标系
const convertCoordinates = (lng, lat) => {
  // 确保坐标在有效范围内
  if (isFinite(lng) && isFinite(lat)) {
    return [lng, lat]
  }
  return [0, 0] // 默认坐标
}
```

#### 3. 地图事件监听错误
**错误现象**：地图交互功能异常
**原因分析**：
- 事件监听器重复绑定
- 事件处理函数错误
- 内存泄漏

**解决方案**：
```javascript
// 在组件卸载时清理事件监听器
onUnmounted(() => {
  if (map) {
    map.off('click', handleMapClick)
  }
})
```

### 车辆数据相关错误

#### 1. 数据过滤错误
**错误现象**：车辆列表过滤功能异常
**原因分析**：
- 过滤条件逻辑错误
- 数据类型不匹配
- 搜索算法效率低

**解决方案**：
```javascript
// 使用高效的过滤算法
const filterVehicles = (vehicles, searchTerm) => {
  if (!searchTerm) return vehicles
  
  const term = searchTerm.toLowerCase()
  return vehicles.filter(vehicle => 
    vehicle.name.toLowerCase().includes(term) ||
    vehicle.plate.toLowerCase().includes(term)
  )
}
```

#### 2. 车辆状态更新错误
**错误现象**：车辆状态显示不正确
**原因分析**：
- 状态判断逻辑错误
- 数据更新时机不当
- 状态枚举值不匹配

**解决方案**：
```javascript
// 统一状态判断逻辑
const getVehicleStatus = (vehicle) => {
  if (!vehicle.lastUpdate) return 'offline'
  
  const timeDiff = Date.now() - vehicle.lastUpdate
  if (timeDiff > 5 * 60 * 1000) return 'offline'
  if (vehicle.speed === 0) return 'parking'
  return 'online'
}
```

### 性能相关错误

#### 1. 大量车辆渲染性能问题
**错误现象**：100+ 车辆时页面卡顿
**原因分析**：
- DOM 元素过多
- 事件监听器过多
- 频繁的状态更新

**解决方案**：
```javascript
// 使用虚拟滚动或分页
const useVirtualList = (items, pageSize = 50) => {
  const [currentPage, setCurrentPage] = useState(1)
  const startIndex = (currentPage - 1) * pageSize
  const endIndex = startIndex + pageSize
  
  return items.slice(startIndex, endIndex)
}
```

#### 2. 内存泄漏
**错误现象**：长时间使用后内存占用过高
**原因分析**：
- 事件监听器未清理
- 定时器未清除
- 闭包引用

**解决方案**：
```javascript
// 在组件卸载时清理所有资源
onUnmounted(() => {
  // 清理定时器
  if (updateTimer) {
    clearInterval(updateTimer)
  }
  
  // 清理事件监听器
  if (map) {
    map.off('click', handleMapClick)
  }
  
  // 清理引用
  map = null
  markers = []
})
```

## 测试最佳实践

### 测试文件组织
```
tests/
├── unit/           # 单元测试
│   ├── components/ # 组件测试
│   ├── stores/     # 状态管理测试
│   └── utils/      # 工具函数测试
├── integration/    # 集成测试
├── e2e/           # 端到端测试
└── docs/          # 测试文档
```

### 测试命名规范
- 测试文件以 `.test.js` 或 `.spec.js` 结尾
- 测试用例使用描述性的名称
- 按功能模块组织测试文件

### 测试覆盖率
- 目标覆盖率：80% 以上
- 重点关注核心业务逻辑
- 定期检查覆盖率报告

## 调试技巧

### 浏览器调试
1. **使用 Vue DevTools**：调试 Vue 组件状态
2. **使用浏览器开发者工具**：调试 JavaScript 错误
3. **使用网络面板**：调试 API 请求

### 日志调试
```javascript
// 使用 console.log 进行调试
console.log('Vehicle data:', vehicles)
console.log('Map bounds:', map.getBounds())

// 使用 debugger 断点调试
debugger
```

### 错误监控
1. **错误边界**：捕获组件错误
2. **错误上报**：收集错误信息
3. **性能监控**：监控应用性能

## 持续集成测试

### 自动化测试
1. **提交前测试**：在代码提交前运行测试
2. **构建测试**：在构建过程中运行测试
3. **部署测试**：在部署前进行测试

### 测试报告
1. **测试结果报告**：生成详细的测试报告
2. **覆盖率报告**：显示代码覆盖率
3. **性能报告**：监控测试性能

## 经验总结

### 成功经验
1. **及早测试**：在开发早期就开始编写测试
2. **测试驱动开发**：先写测试，再写代码
3. **持续集成**：自动化测试流程

### 失败教训
1. **测试覆盖不足**：导致生产环境出现 bug
2. **测试数据不真实**：无法发现真实问题
3. **测试维护不及时**：测试代码过时

### 改进方向
1. **提高测试覆盖率**：增加更多测试用例
2. **优化测试性能**：减少测试执行时间
3. **改进测试质量**：提高测试的可靠性 