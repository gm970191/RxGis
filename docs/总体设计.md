# RxGis 系统总体设计文档

## 1. 系统概述

RxGis 是一个基于 JT808 协议的车辆监控管理系统，主要包含三个核心子系统：
- **WEB服务前台**：基于 Vue 的地图展示和用户交互界面
- **JT808Server**：支持大规模并发的 TCP 服务器，处理车载终端通信
- **WEB服务后台**：提供 RESTful API 服务

## 2. 系统架构

### 2.1 整体架构图

```
┌─────────────────┐    HTTP/WebSocket    ┌─────────────────┐
│   WEB前台       │ ◄──────────────────► │   WEB后台       │
│   (Vue.js)      │                      │   (Python)      │
└─────────────────┘                      └─────────────────┘
         │                                        │
         │                                        │
         │                                        │
         ▼                                        ▼
┌─────────────────┐                      ┌─────────────────┐
│   地图服务       │                      │   数据库集群     │
│   (高德/百度)    │                      │   (MySQL)       │
└─────────────────┘                      └─────────────────┘
                                                │
                                                │
                                                ▼
┌─────────────────┐    JT808协议        ┌─────────────────┐
│   JT808Server   │ ◄──────────────────► │   车载终端      │
│   (Python)      │                      │   (3万并发)     │
└─────────────────┘                      └─────────────────┘
```

### 2.2 技术栈选型

| 组件 | 技术选型 | 版本 | 说明 |
|------|----------|------|------|
| 前端框架 | Vue.js | 3.x | 响应式框架，生态完善 |
| 地图服务 | 高德地图API | 最新版 | 支持实时定位和历史轨迹 |
| 后端框架 | FastAPI | 0.104+ | 高性能异步框架 |
| TCP服务器 | asyncio | Python 3.8+ | 原生异步支持 |
| 数据库 | MySQL | 8.0+ | 主从复制，分库设计 |
| 消息队列 | Redis | 6.0+ | 缓存和消息传递 |
| 容器化 | Docker | 最新版 | 便于部署和扩展 |

## 3. 数据库设计

### 3.1 数据库分库策略

根据数据重要性和备份频率要求，将数据库分为三个独立的数据库实例：

#### JT808Core 数据库
- **用途**：系统配置、用户业务关键配置
- **备份频率**：< 1小时
- **主要表**：
  - 用户表 (users)
  - 车辆信息表 (vehicles)
  - 终端设备表 (terminals)
  - 系统配置表 (system_configs)
  - 权限表 (permissions)

#### JT808Fast 数据库
- **用途**：车辆终端状态数据、系统报表、业务报表、地理位置简化对照表
- **备份频率**：按日备份
- **主要表**：
  - 车辆实时状态表 (vehicle_status)
  - 位置信息表 (locations)
  - 业务报表表 (business_reports)
  - 地理位置对照表 (geo_references)

#### JT808Data 数据库
- **用途**：车载终端消息日志、告警日志、系统日志
- **备份频率**：按周备份
- **主要表**：
  - 消息日志表 (message_logs)
  - 告警日志表 (alarm_logs)
  - 系统日志表 (system_logs)
  - 操作审计表 (audit_logs)

### 3.2 核心表结构设计

#### 车辆信息表 (vehicles)
```sql
CREATE TABLE vehicles (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    vehicle_no VARCHAR(20) NOT NULL COMMENT '车牌号',
    terminal_id VARCHAR(20) UNIQUE NOT NULL COMMENT '终端ID',
    vehicle_type VARCHAR(50) COMMENT '车辆类型',
    owner_name VARCHAR(100) COMMENT '车主姓名',
    contact_phone VARCHAR(20) COMMENT '联系电话',
    status TINYINT DEFAULT 1 COMMENT '状态：1-正常，0-停用',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_vehicle_no (vehicle_no),
    INDEX idx_terminal_id (terminal_id)
);
```

#### 位置信息表 (locations)
```sql
CREATE TABLE locations (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    terminal_id VARCHAR(20) NOT NULL COMMENT '终端ID',
    latitude DECIMAL(10,7) NOT NULL COMMENT '纬度',
    longitude DECIMAL(10,7) NOT NULL COMMENT '经度',
    altitude INT COMMENT '海拔',
    speed INT COMMENT '速度(km/h)',
    direction INT COMMENT '方向(0-359度)',
    location_time TIMESTAMP NOT NULL COMMENT '定位时间',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_terminal_time (terminal_id, location_time),
    INDEX idx_location_time (location_time)
);
```

## 4. 系统交互设计

### 4.1 WEB前台与JT808Server交互方案

**推荐方案：统一通过WEB后台API进行交互**

**优点：**
- 安全性更高，避免前端直接访问TCP服务
- 便于权限控制和审计
- 接口统一，便于维护
- 支持负载均衡和故障转移

**缺点：**
- 增加了一层网络跳转
- 需要额外的API开发工作

**技术实现：**
- 使用WebSocket实现实时消息推送
- RESTful API处理控制命令
- Redis作为消息中间件

### 4.2 消息交互技术选型

#### 方案一：WebSocket + RESTful API
- **适用场景**：实时位置更新、状态推送
- **优点**：实时性好，双向通信
- **缺点**：连接管理复杂

#### 方案二：Server-Sent Events (SSE)
- **适用场景**：单向实时数据推送
- **优点**：实现简单，自动重连
- **缺点**：只支持单向通信

#### 方案三：轮询 + RESTful API
- **适用场景**：非实时数据查询
- **优点**：实现简单，兼容性好
- **缺点**：实时性差，服务器压力大

**最终推荐：WebSocket + RESTful API 组合方案**

## 5. 性能设计

### 5.1 并发处理能力
- **JT808Server**：支持3万并发连接
- **单连接数据量**：平均30秒1K数据
- **总吞吐量**：约1MB/s

### 5.2 优化策略
- 使用连接池管理数据库连接
- Redis缓存热点数据
- 数据库读写分离
- 异步处理非关键操作

## 6. 安全设计

### 6.1 认证授权
- JWT Token认证
- 基于角色的权限控制(RBAC)
- API访问频率限制

### 6.2 数据安全
- 敏感数据加密存储
- HTTPS传输加密
- 数据库连接加密

## 7. 部署架构

### 7.1 容器化部署
```
┌─────────────────┐
│   Nginx         │ (负载均衡)
└─────────────────┘
         │
    ┌────┴────┐
    │         │
┌───▼───┐ ┌───▼───┐
│Web前台│ │Web后台│
└───────┘ └───────┘
              │
         ┌────┴────┐
         │         │
    ┌────▼────┐ ┌──▼────┐
    │JT808Srv │ │Redis  │
    └─────────┘ └───────┘
              │
         ┌────┴────┐
         │         │
    ┌────▼────┐ ┌──▼────┐
    │JT808Core│ │JT808Fast│
    └─────────┘ └───────┘
              │
         ┌────▼────┐
         │JT808Data│
         └─────────┘
```

### 7.2 监控告警
- 系统性能监控
- 业务指标监控
- 异常告警机制

## 8. 开发规范

### 8.1 代码组织
```
RxGis/
├── docs/                    # 设计文档
├── frontend/               # Vue前端代码
├── backend/                # Python后端代码
├── jt808server/           # JT808服务器代码
├── tests/                  # 测试代码
├── docker/                 # Docker配置文件
└── scripts/                # 部署脚本
```

### 8.2 测试策略
- 单元测试：覆盖率 > 80%
- 集成测试：API接口测试
- 性能测试：并发压力测试
- 端到端测试：完整业务流程测试

## 9. 项目里程碑

### 第一阶段：基础架构搭建
- 数据库设计和创建
- 基础API框架搭建
- 前端项目初始化

### 第二阶段：核心功能开发
- JT808Server开发
- 地图显示模块
- 基础CRUD功能

### 第三阶段：高级功能
- 实时位置追踪
- 历史轨迹回放
- 报表统计功能

### 第四阶段：优化和测试
- 性能优化
- 安全加固
- 全面测试

## 10. 风险评估

### 10.1 技术风险
- 大规模并发连接稳定性
- 数据库性能瓶颈
- 实时数据同步一致性

### 10.2 缓解措施
- 充分的压力测试
- 数据库优化和分库
- 消息队列保证数据一致性 