<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>setBounds修复测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            padding: 8px 16px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        #map {
            width: 100%;
            height: 400px;
            border: 1px solid #ddd;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>setBounds修复测试</h1>
    
    <div class="test-section">
        <div class="test-title">地图测试</div>
        <div id="map"></div>
        <div>
            <button onclick="testSetBounds()">测试setBounds</button>
            <button onclick="testBackupMethod()">测试备用方法</button>
            <button onclick="clearResults()">清空结果</button>
        </div>
        <div id="testResult"></div>
    </div>

    <script>
        let map = null;
        let bounds = null;

        // 初始化地图
        function initMap() {
            if (typeof AMap === 'undefined') {
                addResult('error', '高德地图API未加载')
                return;
            }

            try {
                map = new AMap.Map('map', {
                    zoom: 10,
                    center: [116.397428, 39.90923]
                });
                addResult('success', '地图初始化成功')
            } catch (error) {
                addResult('error', `地图初始化失败: ${error.message}`)
            }
        }

        // 测试setBounds方法
        function testSetBounds() {
            if (!map) {
                addResult('error', '地图未初始化')
                return;
            }

            addResult('info', '=== 开始测试setBounds ===')

            // 测试数据：车辆001和008的位置
            const positions = [
                [116.36187258511256, 39.431752417386456], // 车辆001
                [116.71812157107787, 40.02975060258554]   // 车辆008
            ];

            try {
                // 计算边界
                const lngs = positions.map(pos => pos[0])
                const lats = positions.map(pos => pos[1])
                
                const minLng = Math.min(...lngs)
                const maxLng = Math.max(...lngs)
                const minLat = Math.min(...lats)
                const maxLat = Math.max(...lats)
                
                addResult('info', `计算边界范围: minLng=${minLng.toFixed(6)}, maxLng=${maxLng.toFixed(6)}, minLat=${minLat.toFixed(6)}, maxLat=${maxLat.toFixed(6)}`)
                
                // 创建边界对象
                bounds = new AMap.Bounds(
                    [minLng, minLat], // 西南角
                    [maxLng, maxLat]  // 东北角
                )
                
                // 检查bounds是否有效
                const southWest = bounds.getSouthWest()
                const northEast = bounds.getNorthEast()
                
                addResult('info', `边界西南角: [${southWest.lng.toFixed(6)}, ${southWest.lat.toFixed(6)}]`)
                addResult('info', `边界东北角: [${northEast.lng.toFixed(6)}, ${northEast.lat.toFixed(6)}]`)
                
                if (southWest && northEast && 
                    !isNaN(southWest.lng) && !isNaN(southWest.lat) &&
                    !isNaN(northEast.lng) && !isNaN(northEast.lat)) {
                    
                    // 测试不带padding的setBounds
                    try {
                        map.setBounds(bounds)
                        addResult('success', 'setBounds成功（无padding）')
                    } catch (error) {
                        addResult('error', `setBounds失败（无padding）: ${error.message}`)
                        
                        // 测试带padding的setBounds
                        try {
                            map.setBounds(bounds, {
                                padding: [50, 50, 50, 50]
                            })
                            addResult('success', 'setBounds成功（有padding）')
                        } catch (paddingError) {
                            addResult('error', `setBounds失败（有padding）: ${paddingError.message}`)
                            addResult('warning', '将使用备用方法')
                            useBackupMethod(minLng, maxLng, minLat, maxLat)
                        }
                    }
                } else {
                    addResult('error', '边界对象无效')
                }
            } catch (error) {
                addResult('error', `边界计算失败: ${error.message}`)
            }
            
            addResult('info', '=== setBounds测试完成 ===')
        }

        // 备用方法
        function useBackupMethod(minLng, maxLng, minLat, maxLat) {
            if (!map) {
                addResult('error', '地图未初始化')
                return;
            }

            addResult('info', '=== 使用备用方法 ===')
            
            // 计算中心点
            const centerLng = (minLng + maxLng) / 2
            const centerLat = (minLat + maxLat) / 2
            
            // 计算缩放级别
            const lngDiff = maxLng - minLng
            const latDiff = maxLat - minLat
            const maxDiff = Math.max(lngDiff, latDiff)
            
            let zoom = 15
            if (maxDiff > 0.1) zoom = 10
            else if (maxDiff > 0.05) zoom = 11
            else if (maxDiff > 0.02) zoom = 12
            else if (maxDiff > 0.01) zoom = 13
            else if (maxDiff > 0.005) zoom = 14
            else if (maxDiff > 0.002) zoom = 15
            else zoom = 16
            
            addResult('info', `备用方法: 中心点[${centerLng.toFixed(6)}, ${centerLat.toFixed(6)}], 缩放级别${zoom}, 最大差值${maxDiff.toFixed(6)}`)
            
            try {
                map.setCenter([centerLng, centerLat])
                map.setZoom(zoom)
                addResult('success', '备用方法执行成功')
            } catch (error) {
                addResult('error', `备用方法失败: ${error.message}`)
            }
        }

        // 测试备用方法
        function testBackupMethod() {
            if (!map) {
                addResult('error', '地图未初始化')
                return;
            }

            const minLng = 116.36187258511256
            const maxLng = 116.71812157107787
            const minLat = 39.431752417386456
            const maxLat = 40.02975060258554
            
            useBackupMethod(minLng, maxLng, minLat, maxLat)
        }

        function addResult(type, message) {
            const container = document.getElementById('testResult')
            const div = document.createElement('div')
            div.className = `test-result ${type}`
            div.textContent = message
            container.appendChild(div)
        }

        function clearResults() {
            document.getElementById('testResult').innerHTML = ''
        }

        // 页面加载时初始化地图
        window.onload = function() {
            console.log('setBounds修复测试页面已加载')
            initMap()
        }
    </script>
    <script src="https://webapi.amap.com/maps?v=1.4.15&key=7b76094fca96419d18d412ca835c9e88"></script>
</body>
</html> 